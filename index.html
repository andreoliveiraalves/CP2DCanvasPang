<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>PANG_GAME</title>
    <style>
        canvas,
        button {
            /* Centrar canvas na página */
            padding-left: 0;
            padding-right: 0;
            margin-left: auto;
            margin-right: auto;
            display: block;
        }
    </style>
</head>

<body>
    <canvas class="center" id="myCanvas" width="800" height="475" style="border:solid 1px black">
        Your browser does not support HTML5 Canvas.
    </canvas>
    <button id="btn" onclick="multiplayer()">Multiplayer</button>
    <script>
        //obter contexto do canvas //
        const canvas = document.querySelector('#myCanvas');
        const ctx = canvas.getContext("2d");

        //definição de propriedades do canvas //
        const W = canvas.width,
            H = canvas.height;

        //Definição de coordenadas iniciais para o personagem //
        let charX = W / 2,
            charY = 305,
            char2X = W * 2 / 3,
            char2Y = 305,
            bullet1Y = 250;
            bullet2Y = 250;
            ballsnumber = 3;
            

        //Carregando assets //
        let images = {};

        function loadImage(name) {
            images[name] = new Image();
            images[name].src = "./img/" + name + ".png";
            images[name].onload = function () {
                setInterval(1000 / 20);
            };
        }
        loadImage('bg');
        loadImage('charL');
        loadImage('charR');
        loadImage('tile');
        loadImage('hp');
        loadImage('bullet');
        loadImage('char2L');
        loadImage('char2R');
        loadImage('charUp');
        loadImage('char2Up');
        loadImage('shoot1');
        loadImage('shoot2');

        // Boleano de Controlo de direção //
        let movesRight2 = false;
        let movesRight = true;
        let lookingUp = false;
        let lookingUp2 = false;
        let isMultiplayer = false;

        // Construção de classe para as bolas //

        class Ball {
            constructor(x, y, r, d,a, c) { //construtor
                this.R = r; //radius
                this.x = x; // initial X position
                this.y = y; // initial Y position
                this.a = a;
                this.dX = 6 * Math.cos(-d);
                this.dY = 3 * Math.sin(-d/2);
                this.c = c; //cor
            }
            draw() {
                ctx.fillStyle = this.c;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.R, 0, 2 * Math.PI);
                ctx.strokeStyle = "black";
                ctx.lineWidth = 2;
                ctx.stroke();
                ctx.fill();
            }
            update() {

                if (this.x < this.R || this.x > W - this.R) {
                    this.dX = -this.dX
                }
                if (this.y < 0 + this.R || this.y > 430 - this.R) {
                    this.dY = -this.dY
                }
                else{
                    this.dY+=this.a
                }
                this.x += this.dX;; // update horizontal position
                this.y += this.dY;; // update vertical position

            }

        }
        // Criação de array para as bolas // 

        // setup as many balls as wanted
        let b = new Array();
        for (let i = 0; i < ballsnumber; i++) {
            //random color
            let R = Math.floor(Math.random() * 256);
            let G = Math.floor(Math.random() * 256);
            let B = Math.floor(Math.random() * 256);
            let color = `rgb(${R},${G},${B})`;

            //random size
            let radius = 40;

            // random position in X
            let xInit = 50 + 550 * Math.random();
            // above Canvas in Y
            let yInit = H / 5;

            //random velocity
            let direction = Math.random() * 2 * Math.PI;
            let a = 0.2;
            // x, y, r, v, c
            b.push(new Ball(xInit, yInit, radius, direction,a, color));
        }

        function multiplayer() {
            if (isMultiplayer == true){
                window.location.reload();
            }
            else{
            isMultiplayer = true;
            charX = W / 3;
            ballsnumber= 5;
            }
        }
        // Strings do Jogo // 
        
        let hpTxt = 3;
        
        function shoot(){
            if(lookingUp == true){
            while(bullet1Y!=-55){
            ctx.drawImage(images['shoot1'],charX+56,bullet1Y+50,10,13)
            bullet1Y-=5;
            }
            bullet1Y=250;
            }
            if(lookingUp2 == true){
                while(bullet2Y!=-55){
                    ctx.drawImage(images['shoot2'],char2X+56,bullet2Y+50,10,13)
                    bullet2Y-=5;
                }
                bullet2Y=250;
            }
        }


        // Desenho inicial //

        function drawBackground() {

            // limpar canvas // 

            ctx.clearRect(0, 0, W, H);
            // criar chão //
            for (let i = 0; i < 8; i++) {
                ctx.drawImage(images['tile'], 100 * i, 430);
            }
            // criar fundo //
            ctx.drawImage(images['bg'], 10, 0, images['bg'].width, images['bg'].height, 0, 0, 1050, 470);

            // desenhar barra de status //

            ctx.drawImage(images['hp'], 30, 30, 35, 35);
            ctx.fillStyle = "black";
            ctx.fillText(hpTxt, 75, 60);
            ctx.font = '30px fantasy';
        }

        // função de atualização // 

        function update() {
            if (isMultiplayer == false) {
                if (movesRight == true && lookingUp == false) {
                    ctx.drawImage(images['charR'], charX, charY);
                }
                if (movesRight == false && lookingUp == false) {
                    ctx.drawImage(images['charL'], charX, charY)
                }
                if (lookingUp == true) {
                    ctx.drawImage(images['charUp'], charX, charY);
                    shoot();
                }
            } else {
                if (movesRight == true && lookingUp == false) {
                    ctx.drawImage(images['charR'], charX, charY);
                }
                if (movesRight == false && lookingUp == false) {
                    ctx.drawImage(images['charL'], charX, charY);
                }
                if (lookingUp == true){
                    ctx.drawImage(images['charUp'], charX, charY);
                    shoot();
                }
                if (movesRight2 == true && lookingUp2 == false) {
                    ctx.drawImage(images['char2R'], char2X, char2Y);
                }
                if (movesRight2 == false && lookingUp2 == false) {
                    ctx.drawImage(images['char2L'], char2X, char2Y);
                }
                if (lookingUp2 == true){
                    ctx.drawImage(images['char2Up'], char2X, char2Y);
                    shoot();
                }
            }
        }


        //função de renderização //

        function render() {


            drawBackground();
            update();
            b.forEach(function (ball) {
                ball.draw();
                ball.update();
            });
            window.requestAnimationFrame(render);
        }
        render();

        //definição de controlos //

        document.onkeydown = function (e) {
            switch (e.key) {
                case 'ArrowLeft':
                    /*LEFT arrow*/
                    if (charX > 0) {
                        charX -= 30;
                        movesRight = false;
                        lookingUp = false;
                    };
                    break;
                case 'ArrowRight':
                    /*RIGHT arrow*/
                    if (charX < canvas.width - 80) {
                        charX += 30;
                        movesRight = true
                        lookingUp = false;
                    };
                    break;
                case 'ArrowUp':
                    lookingUp = true;
                    break;
                case 'a':
                    char2X -= 30;
                    movesRight2 = false;
                    lookingUp2 = false;
                    break;
                case 'd':
                    char2X += 30;
                    movesRight2 = true;
                    lookingUp2 = false;
                    break;
                case 'w':
                    lookingUp2 = true;

            }
            e.preventDefault();
        }
        window.addEventListener("ArrowUp", onkeydown, false);
    </script>
</body>

</html>
